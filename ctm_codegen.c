/*              
 *⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⠤⠖⠚⢉⣩⣭⡭⠛⠓⠲⠦⣄⡀⠀⠀⠀⠀⠀⠀⠀
 *⠀⠀⠀⠀⠀⠀⠀⢀⡴⠋⠁⠀⠀⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠳⢦⡀⠀⠀⠀⠀
 *⠀⠀⠀⠀⠀⢀⡴⠃⢀⡴⢳⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⣆⠀⠀⠀
 *⠀⠀⠀⠀⠀⡾⠁⣠⠋⠀⠈⢧⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢧⠀⠀
 *⠀⠀⠀⠀⣸⠁⢰⠃⠀⠀⠀⠈⢣⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⣇⠀
 *⠀⠀⠀⠀⡇⠀⡾⡀⠀⠀⠀⠀⣀⣹⣆⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢹⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀,----,               
 *⠀⠀⠀⢸⠃⢀⣇⡈⠀⠀⠀⠀⠀⠀⢀⡑⢄⡀⢀⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀,/⠀⠀⠀.`|⠀⠀⠀⠀⠀⠀⠀____   
 *⠀⠀⠀⢸⠀⢻⡟⡻⢶⡆⠀⠀⠀⠀⡼⠟⡳⢿⣦⡑⢄⠀⠀⠀⠀⠀⠀⠀⠀⢸⡇⠀⠀⠀,----..⠀⠀⠀⠀⠀,`⠀⠀⠀.'⠀⠀:⠀⠀⠀⠀⠀,'⠀, `. 
 *⠀⠀⠀⣸⠀⢸⠃⡇⢀⠇⠀⠀⠀⠀⠀⡼⠀⠀⠈⣿⡗⠂⠀⠀⠀⠀⠀⠀⠀⢸⠁⠀⠀/⠀⠀⠀/⠀⠀\⠀⠀⠀;⠀⠀⠀;⠀⠀⠀ /⠀⠀⠀,-+-,.'⠀_⠀| 
 *⠀⠀⠀⡏⠀⣼⠀⢳⠊⠀⠀⠀⠀⠀⠀⠱⣀⣀⠔⣸⠁⠀⠀⠀⠀⠀⠀⠀⢠⡟⠀⠀⠀|⠀⠀:⠀⠀⠀⠀:.'___,/⠀ ⠀ ,'⠀,-+-.⠀;⠀⠀⠀,⠀|| 
 *⠀⠀⠀⡇⢀⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠠⠀⡇⠀⠀⠀⠀⠀⠀⠀⠀⢸⠃⠀⠀⠀.⠀⠀|⠀;. /⠀|⠀⠀⠀:⠀⠀⠀ |⠀,--.'|'⠀   |  ;| 
 *⠀⠀⠀⢸⠃⠘⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⠁⠀⠀⢀⠀⠀⠀⠀⠀⣾⠀⠀⠀.⠀⠀;⠀/--` ;⠀⠀⠀|.';  ;⠀|⠀⠀|⠀⠀,',⠀|⠀ ': 
 *⠀⠀⠀⣸⠀⠀⠹⡄⠀⠀⠈⠁⠀⠀⠀⠀⠀⠀⠀⡞⠀⠀⠀⠸⠀⠀⠀⠀⠀⡇⠀⠀⠀;⠀⠀|⠀;⠀⠀⠀`----'⠀⠀|⠀|⠀|⠀⠀|⠀/⠀ |⠀|⠀⠀|| 
 *⠀⠀⠀⡏⠀⠀⠀⠙⣆⠀⠀⠀⠀⠀⠀⠀⢀⣠⢶⡇⠀⠀⢰⡀⠀⠀⠀⠀⠀⡇⠀⠀⠀|⠀⠀:⠀|⠀⠀⠀⠀⠀⠀⠀'⠀ :⠀;⠀'⠀⠀| :⠀⠀|⠀:⠀⠀|, 
 *⠀⠀⢰⠇⡄⠀⠀⠀⡿⢣⣀⣀⣀⡤⠴⡞⠉⠀⢸⠀⠀⠀⣿⡇⠀⠀⠀⠀⠀⣧⠀⠀⠀.⠀⠀|⠀'___⠀⠀⠀⠀⠀|⠀ |⠀'⠀;⠀⠀. |⠀ ;⠀|--'  
 *⠀⠀⣸⠀⡇⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⢹⠀⠀⢸⠀⠀⢀⣿⠇⠀⠀⠀⠁⠀⢸⠀⠀⠀'⠀⠀;⠀: .'|⠀⠀⠀⠀'⠀⠀:⠀|⠀|⠀⠀: |⠀⠀|⠀,     
 *⠀⠀⣿⠀⡇⠀⠀⠀⠀⠀⢀⡤⠤⠶⠶⠾⠤⠄⢸⠀⡀⠸⣿⣀⠀⠀⠀⠀⠀⠈⣇⠀⠀'⠀⠀|⠀'/⠀:⠀⠀⠀⠀ ;⠀ |.'⠀ |⠀ : '⠀ |/      
 *⠀⠀⡇⠀⡇⠀⠀⡀⠀⡴⠋⠀⠀⠀⠀⠀⠀⠀⠸⡌⣵⡀⢳⡇⠀⠀⠀⠀⠀⠀⢹⠀⠀|⠀⠀:⠀⠀⠀/⠀⠀⠀⠀⠀'---'⠀ ⠀;⠀⠀| |`-'       
 *⠀⠀⡇⠀⠇⠀⠀⡇⡸⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⠮⢧⣀⣻⢂⠀⠀⠀⠀⠀⠀⢧⠀⠀\⠀⠀\ .'⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀|⠀⠀;/           
 *⠀⠀⣇⠀⢠⠀⠀⢳⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⡎⣆⠀⠀⠀⠀⠀⠘⠀⠀⠀`---`⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀'---'            
 *⠀⠀⢻⠀⠈⠰⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠰⠘⢮⣧⡀⠀⠀⠀⠀⠀       ⠀
 *⠀⠀⠸⡆⠀⠀⠇⣾⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⠆⠀⠀⠀⠀⠀⠀⠀⠙⠳⣄⡀⢢⡀⠀⠀⠀⠀⠀     ⠀
 *
 *  CTM - C TO MIPS
 *  Copyright (c) 2022 Leonardo Z. Nunes
 *
 *  this program is free software: you can redistribute it and/or modify
 *  it under the terms of the gnu general public license as published by
 *  the free software foundation, either version 3 of the license, or
 *  (at your option) any later version.
 *
 *  this program is distributed in the hope that it will be useful,
 *  but without any warranty; without even the implied warranty of
 *  merchantability or fitness for a particular purpose.  see the
 *  gnu general public license for more details.
 *
 *  you should have received a copy of the gnu general public license
 *  along with this program.  if not, see <http://www.gnu.org/licenses/>.
 */
#include "ctm_ast.h"

#include <stdio.h>

void
code_gen_main(CtmAstNode_t * ast, size_t saved_regs)
{
    if (!ast) return;
    code_gen_main(ast->typeP, saved_regs);


    if (ast->type == MAIN && ast->dtype == MAIN_TK)
        {
            printf("main:\n");
        }
    else if (ast->type == ARG && ast->dtype != VOID_TK)
        {
            size_t regI = 0;
            CtmAstNode_t * aux = ast;
            while (aux->type != ARG)
                {
                    printf("li $t%zu, 0\n", regI++);
                    if (regI == 7) break;
                    aux = aux->next;
                }
        }
    else if (ast->type == ASSIG)
        {
            if (ast->right->dtype == RPAREN_TK)
                {
                    printf("li $s%zu, %s\n", saved_regs, ast->right->right->value);
                }
            else
                {
                    printf("li $s%zu, %s\n", saved_regs, ast->right->value);
                }
        }
    else if (ast->type == EXP
             && ast->dtype != CONSTANT_TK
             && ast->dtype != LPAREN_TK
             && ast->dtype != RPAREN_TK)
        {
            if (ast->dtype == PLUS_TK)
                {
                    if (ast->right->dtype == RPAREN_TK)
                        {
                            printf("addi $s%zu, $s%zu, %s\n", saved_regs, saved_regs, ast->right->right->value);
                        }
                    else
                        {
                            printf("addi $s%zu, $s%zu, %s\n", saved_regs, saved_regs, ast->right->value);
                        }
                }
            else if (ast->dtype == MULT_TK)
                {
                    if (ast->right->dtype == RPAREN_TK)
                        {
                            printf("mul $s%zu, $s%zu, %s\n", saved_regs, saved_regs, ast->right->right->value);
                        }
                    else
                        {
                            printf("mul $s%zu, $s%zu, %s\n", saved_regs, saved_regs, ast->right->value);

                        }
                }
            else
                {
                    printf("EXPRESSION NOT FOUND\n");
                }
        }
    else if (ast->type == RET)
        {
            if (ast->dtype == RETURN_TK)
                {
                    printf("li $v0, 10\n"\
                           "syscall\n");
                }
        }


    code_gen_main(ast->next, saved_regs);
    code_gen_main(ast->right, saved_regs);
    code_gen_main(ast->left, saved_regs);
}

void
code_gen_gen(CtmExpList_t * head)
{
    size_t saved_regs = 0;
    switch(head->ast->type)
        {
        case MAIN:
            code_gen_main(head->ast, saved_regs);
            break;
        default:
            return;
        }
}

void
code_gen(CtmAst_t * ast)
{
    printf(".text\n" \
           ".globl main\n");
    code_gen_gen(ast->head);
}
